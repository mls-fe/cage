/**
 * commands:
 *  setup
 *      在当前目录下获取
 *  config(c)
 *  run(r)
 *  stop(s)
 */

'use strict';

var _bluebird = require('bluebird');

require('./log');
require('./profile');

var Commander = require('commander'),
    Moment = require('moment'),
    Tail = require('tail').Tail,
    ConfigCLI = require('./cli/config'),
    SetupCLI = require('./cli/setup'),
    WorkSpaceCLI = require('./cli/workspace'),
    WorkSpace = require('./core/workspace'),
    Update = require('./update'),
    pkg = require('../package.json'),
    logValues = { 's': 1, 'js': 1 },
    findValidWorkspace = _bluebird.coroutine(function* (dir) {
    var isValid = yield WorkSpace.isValidWorkSpace(dir);

    if (!isValid) {
        dir = WorkSpace.current();
        isValid = yield WorkSpace.isValidWorkSpace(dir);
    }

    if (isValid) {
        return { isValid: isValid, dir: dir };
    } else {
        log('无法找到可运行的工作空间', 'error');
        throw new Error();
    }
});

Commander.version(pkg.version, '-v, --version');

Commander.command('setup').action(function () {
    return new SetupCLI();
});

Commander.command('config [dir]').alias('c').action(function () {
    var dir = arguments[0] === undefined ? process.cwd() : arguments[0];
    return new ConfigCLI(dir);
});

Commander.command('run').alias('r').action(_bluebird.coroutine(function* () {
    var result = yield findValidWorkspace(process.cwd());
    new WorkSpace(result.dir).start();
}));

Commander.command('stop [isAll]').alias('s').action(_bluebird.coroutine(function* () {
    var isAll = arguments[0] === undefined ? false : arguments[0];

    var result = yield findValidWorkspace(process.cwd());
    new WorkSpace(result.dir).stop(isAll);
}));

Commander.command('log [type]').action(function () {
    var type = arguments[0] === undefined ? 's' : arguments[0];

    if (type in logValues) {
        (function () {
            var date = Moment().format('YYYY/MM/DD'),
                tail = new Tail('/tmp/log/nest-' + type + 'erver/' + date + '.log');

            tail.on('line', function (data) {
                return log(data);
            }).on('error', function () {
                return tail.unwatch();
            });
        })();
    } else {
        log('log 只接受 s/js 两个参数', 'error');
    }
});

Commander.command('ls').action(function () {
    return WorkSpaceCLI.list();
});

Commander.parse(process.argv);

Update.check();
//# sourceMappingURL=data:application/json;base64,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Q0FBRSxZQUFrQjtRQUFoQixJQUFJLGdDQUFHLEdBQUc7O0FBQ2pCLFFBQUssSUFBSSxJQUFJLFNBQVMsRUFBRzs7QUFDckIsZ0JBQUksSUFBSSxHQUFHLE1BQU0sRUFBRSxDQUFDLE1BQU0sQ0FBRSxZQUFZLENBQUU7Z0JBQ3RDLElBQUksR0FBRyxJQUFJLElBQUksb0JBQW1CLElBQUksY0FBUyxJQUFJLFVBQVEsQ0FBQTs7QUFFL0QsZ0JBQUksQ0FDQyxFQUFFLENBQUUsTUFBTSxFQUFFLFVBQUEsSUFBSTt1QkFBSSxHQUFHLENBQUUsSUFBSSxDQUFFO2FBQUEsQ0FBRSxDQUNqQyxFQUFFLENBQUUsT0FBTyxFQUFFO3VCQUFNLElBQUksQ0FBQyxPQUFPLEVBQUU7YUFBQSxDQUFFLENBQUE7O0tBQzNDLE1BQU07QUFDSCxXQUFHLENBQUUsbUJBQW1CLEVBQUUsT0FBTyxDQUFFLENBQUE7S0FDdEM7Q0FDSixDQUFFLENBQUE7O0FBRVAsU0FBUyxDQUNKLE9BQU8sQ0FBRSxJQUFJLENBQUUsQ0FDZixNQUFNLENBQUU7V0FBTSxZQUFZLENBQUMsSUFBSSxFQUFFO0NBQUEsQ0FBRSxDQUFBOztBQUV4QyxTQUFTLENBQUMsS0FBSyxDQUFFLE9BQU8sQ0FBQyxJQUFJLENBQUUsQ0FBQTs7QUFFL0IsTUFBTSxDQUFDLEtBQUssRUFBRSxDQUFBIiwiZmlsZSI6ImluZGV4LmpzIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBjb21tYW5kczpcbiAqICBzZXR1cFxuICogICAgICDlnKjlvZPliY3nm67lvZXkuIvojrflj5ZcbiAqICBjb25maWcoYylcbiAqICBydW4ocilcbiAqICBzdG9wKHMpXG4gKi9cblxucmVxdWlyZSggJy4vbG9nJyApXG5yZXF1aXJlKCAnLi9wcm9maWxlJyApXG5cbmxldCBDb21tYW5kZXIgICAgICAgICAgPSByZXF1aXJlKCAnY29tbWFuZGVyJyApLFxuICAgIE1vbWVudCAgICAgICAgICAgICA9IHJlcXVpcmUoICdtb21lbnQnICksXG4gICAgVGFpbCAgICAgICAgICAgICAgID0gcmVxdWlyZSggJ3RhaWwnICkuVGFpbCxcbiAgICBDb25maWdDTEkgICAgICAgICAgPSByZXF1aXJlKCAnLi9jbGkvY29uZmlnJyApLFxuICAgIFNldHVwQ0xJICAgICAgICAgICA9IHJlcXVpcmUoICcuL2NsaS9zZXR1cCcgKSxcbiAgICBXb3JrU3BhY2VDTEkgICAgICAgPSByZXF1aXJlKCAnLi9jbGkvd29ya3NwYWNlJyApLFxuICAgIFdvcmtTcGFjZSAgICAgICAgICA9IHJlcXVpcmUoICcuL2NvcmUvd29ya3NwYWNlJyApLFxuICAgIFVwZGF0ZSAgICAgICAgICAgICA9IHJlcXVpcmUoICcuL3VwZGF0ZScgKSxcbiAgICBwa2cgICAgICAgICAgICAgICAgPSByZXF1aXJlKCAnLi4vcGFja2FnZS5qc29uJyApLFxuICAgIGxvZ1ZhbHVlcyAgICAgICAgICA9IHsgJ3MnOiAxLCAnanMnOiAxIH0sXG5cbiAgICBmaW5kVmFsaWRXb3Jrc3BhY2UgPSBhc3luYyBkaXIgPT4ge1xuICAgICAgICBsZXQgaXNWYWxpZCA9IGF3YWl0IFdvcmtTcGFjZS5pc1ZhbGlkV29ya1NwYWNlKCBkaXIgKVxuXG4gICAgICAgIGlmICggIWlzVmFsaWQgKSB7XG4gICAgICAgICAgICBkaXIgICAgID0gV29ya1NwYWNlLmN1cnJlbnQoKVxuICAgICAgICAgICAgaXNWYWxpZCA9IGF3YWl0IFdvcmtTcGFjZS5pc1ZhbGlkV29ya1NwYWNlKCBkaXIgKVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKCBpc1ZhbGlkICkge1xuICAgICAgICAgICAgcmV0dXJuIHsgaXNWYWxpZCwgZGlyIH1cbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZyggJ+aXoOazleaJvuWIsOWPr+i/kOihjOeahOW3peS9nOepuumXtCcsICdlcnJvcicgKVxuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yXG4gICAgICAgIH1cbiAgICB9XG5cbkNvbW1hbmRlclxuICAgIC52ZXJzaW9uKCBwa2cudmVyc2lvbiwgJy12LCAtLXZlcnNpb24nIClcblxuQ29tbWFuZGVyXG4gICAgLmNvbW1hbmQoICdzZXR1cCcgKVxuICAgIC5hY3Rpb24oICgpICA9PiBuZXcgU2V0dXBDTEkgKVxuXG5Db21tYW5kZXJcbiAgICAuY29tbWFuZCggJ2NvbmZpZyBbZGlyXScgKVxuICAgIC5hbGlhcyggJ2MnIClcbiAgICAuYWN0aW9uKCAoIGRpciA9IHByb2Nlc3MuY3dkKCkgKSAgPT4gbmV3IENvbmZpZ0NMSSggZGlyICkgKVxuXG5Db21tYW5kZXJcbiAgICAuY29tbWFuZCggJ3J1bicgKVxuICAgIC5hbGlhcyggJ3InIClcbiAgICAuYWN0aW9uKCBhc3luYyAoKSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBmaW5kVmFsaWRXb3Jrc3BhY2UoIHByb2Nlc3MuY3dkKCkgKVxuICAgICAgICBuZXcgV29ya1NwYWNlKCByZXN1bHQuZGlyICkuc3RhcnQoKVxuICAgIH0gKVxuXG5Db21tYW5kZXJcbiAgICAuY29tbWFuZCggJ3N0b3AgW2lzQWxsXScgKVxuICAgIC5hbGlhcyggJ3MnIClcbiAgICAuYWN0aW9uKCBhc3luYyAoIGlzQWxsID0gZmFsc2UgKSA9PiB7XG4gICAgICAgIGxldCByZXN1bHQgPSBhd2FpdCBmaW5kVmFsaWRXb3Jrc3BhY2UoIHByb2Nlc3MuY3dkKCkgKVxuICAgICAgICBuZXcgV29ya1NwYWNlKCByZXN1bHQuZGlyICkuc3RvcCggaXNBbGwgKVxuICAgIH0gKVxuXG5Db21tYW5kZXJcbiAgICAuY29tbWFuZCggJ2xvZyBbdHlwZV0nIClcbiAgICAuYWN0aW9uKCAoIHR5cGUgPSAncycgKSA9PiB7XG4gICAgICAgIGlmICggdHlwZSBpbiBsb2dWYWx1ZXMgKSB7XG4gICAgICAgICAgICBsZXQgZGF0ZSA9IE1vbWVudCgpLmZvcm1hdCggJ1lZWVkvTU0vREQnICksXG4gICAgICAgICAgICAgICAgdGFpbCA9IG5ldyBUYWlsKCBgL3RtcC9sb2cvbmVzdC0ke3R5cGV9ZXJ2ZXIvJHtkYXRlfS5sb2dgIClcblxuICAgICAgICAgICAgdGFpbFxuICAgICAgICAgICAgICAgIC5vbiggJ2xpbmUnLCBkYXRhID0+IGxvZyggZGF0YSApIClcbiAgICAgICAgICAgICAgICAub24oICdlcnJvcicsICgpID0+IHRhaWwudW53YXRjaCgpIClcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGxvZyggJ2xvZyDlj6rmjqXlj5cgcy9qcyDkuKTkuKrlj4LmlbAnLCAnZXJyb3InIClcbiAgICAgICAgfVxuICAgIH0gKVxuXG5Db21tYW5kZXJcbiAgICAuY29tbWFuZCggJ2xzJyApXG4gICAgLmFjdGlvbiggKCkgPT4gV29ya1NwYWNlQ0xJLmxpc3QoKSApXG5cbkNvbW1hbmRlci5wYXJzZSggcHJvY2Vzcy5hcmd2IClcblxuVXBkYXRlLmNoZWNrKClcbiJdfQ==